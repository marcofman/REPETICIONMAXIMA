<!DOCTYPE html>
<html lang="es-CL">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Reestablecer contraseña | Repetición Máxima</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Supabase (usa los mismos valores que en index.html) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL="https://arwxqomdfquhkneufnnh.supabase.co";
    const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFyd3hxb21kZnF1aGtuZXVmbm5oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyODc3MjUsImV4cCI6MjA3Nzg2MzcyNX0.ts0LsML3MBHAEptN9xmUdsFZDX7wETbbWvAVhtrtcqc";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // 1) Al abrir esta página desde el email, Supabase redirige con un access_token (hash)
    // 2) Mostramos formulario para nueva contraseña y la guardamos con updateUser()
    async function handleSubmit(e){
      e.preventDefault();
      const pwd = document.getElementById("newpass").value.trim();
      const pwd2= document.getElementById("newpass2").value.trim();
      if(!pwd || pwd.length<6){ alert("La contraseña debe tener al menos 6 caracteres."); return; }
      if(pwd!==pwd2){ alert("Las contraseñas no coinciden."); return; }

      try{
        const { data: { user }, error } = await sb.auth.updateUser({ password: pwd });
        if(error){ alert("No se pudo actualizar: " + error.message); return; }
        alert("Listo. Tu contraseña fue actualizada.");
        // Opcional: vuelve a la portada
        window.location.href = "/"; // o "https://repeticiomaxima.netlify.app/"
      }catch(err){
        console.error(err);
        alert("Ocurrió un error al actualizar la contraseña.");
      }
    }

    // Mostrar aviso si no llegó con token (acceso directo sin link del correo)
    document.addEventListener("DOMContentLoaded", async () => {
      const { data:{ session } } = await sb.auth.getSession();
      const info = document.getElementById("info");
      if(!session){
        info.textContent = "Abre esta página desde el enlace enviado a tu correo para reestablecer la contraseña.";
      }else{
        info.textContent = "Ingresa tu nueva contraseña:";
      }
    });
  </script>
</head>
<body class="bg-gray-50 text-gray-900">
  <main class="min-h-screen flex items-center justify-center p-6">
    <div class="w-full max-w-md bg-white shadow rounded-2xl p-6">
      <h1 class="text-2xl font-bold mb-2">Reestablecer contraseña</h1>
      <p id="info" class="text-sm text-gray-600 mb-4"></p>

      <form onsubmit="handleSubmit(event)" class="space-y-4">
        <div>
          <label class="block text-sm font-medium mb-1">Nueva contraseña</label>
          <input id="newpass" type="password" required minlength="6" class="w-full px-4 py-3 border rounded-lg"/>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Repite la contraseña</label>
          <input id="newpass2" type="password" required minlength="6" class="w-full px-4 py-3 border rounded-lg"/>
        </div>
        <button class="w-full px-4 py-3 rounded-lg bg-amber-400 font-bold">Guardar</button>
      </form>

      <a href="/" class="block text-center text-sm underline mt-4">Volver al inicio</a>
    </div>
  </main>
</body>
</html>
